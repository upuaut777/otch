//ФиксМакет
//МодульФормы
&НаСервере
Процедура СформироватьНаСервере()
	  ОтчетОбъект=РеквизитФормыВЗначение("Отчет");
  	ОтчетОбъект.СформироватьОтчет(ТабДок);
  	ЗначениеВРеквизитФормы(ОтчетОбъект,"Отчет");

КонецПроцедуры

&НаКлиенте
Процедура Сформировать(Команда)
	  СформироватьНаСервере();
КонецПроцедуры

//МодульОбъекта
Процедура СформироватьОтчет(ТабДок)      Экспорт 
	ТабДок.Очистить();
	
    Макет=ПолучитьМакет("Макет");
	ОбластьЗаголовок=Макет.ПолучитьОбласть("Заголовок");
	ОбластьЗаголовок.Параметры.Дата=Формат(ДатаОтчета,"ДЛФ=DD");
	ТабДок.Вывести(ОбластьЗаголовок); 
	
	ОбластьШапка=Макет.ПолучитьОбласть("Шапка");
	ТабДок.Вывести(ОбластьШапка); 
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ТоварныеЗапасыОстатки.Товар КАК Номенклатура,
		|	ТоварныеЗапасыОстатки.Склад КАК Склад,
		|	ТоварныеЗапасыОстатки.КоличествоОстаток КАК Количество
		|ИЗ
		|	РегистрНакопления.ТоварныеЗапасы.Остатки КАК ТоварныеЗапасыОстатки
		|ИТОГИ
		|	СУММА(КоличествоОстаток)
		|ПО
		|	ОБЩИЕ,
		|	Склад";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаОбщийИтог = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	ВыборкаОбщийИтог.Следующий();		// Общий итог
	
	// Вставить обработку выборки ВыборкаОбщийИтог
	
	ВыборкаСклад = ВыборкаОбщийИтог.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока ВыборкаСклад.Следующий() Цикл 
		
	ОбластьГруппировка=Макет.ПолучитьОбласть("Группировка");
	ОбластьГруппировка.Параметры.Заполнить(ВыборкаСклад);
	ТабДок.Вывести(ОбластьГруппировка); 
	
		ВыборкаДетальныеЗаписи = ВыборкаСклад.Выбрать();
	
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			ОбластьДетальныеЗаписи=Макет.ПолучитьОбласть("ДетальныеЗаписи");
			ОбластьДетальныеЗаписи.Параметры.Заполнить(ВыборкаДетальныеЗаписи);
			ТабДок.Вывести(ОбластьДетальныеЗаписи); 
		КонецЦикла;
	КонецЦикла;
	ОбластьИтоги=Макет.ПолучитьОбласть("Группировка"); 
	ОбластьИтоги.Параметры.Заполнить(ВыборкаОбщийИтог);

	ОбластьИтоги.Параметры.Склад="Итого";
	ТабДок.Вывести(ОбластьИтоги); 
	
	
	
	
КонецПроцедуры	
